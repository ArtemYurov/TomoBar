name: main

on:
  push:
    branches:
      - '*'
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set version for tag
        if: github.ref_type == 'tag'
        run: echo "version=$(git describe --tags --match 'v*')" >> $GITHUB_ENV

      - name: Set version for branch
        if: github.ref_type == 'branch'
        run: echo "version=$(git describe --tags 2>/dev/null || echo "dev-$(git rev-parse --short HEAD)")" >> $GITHUB_ENV

      - name: Select Xcode 16.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Install create-dmg
        if: github.ref_type == 'tag'
        run: brew install create-dmg

      - name: Build
        run: |
          # Create a fake codesign that skips signing in CI
          mkdir -p /tmp/bin
          cat > /tmp/bin/codesign << 'EOF'
          #!/bin/bash
          echo "Skipping codesign in CI environment: $@"
          exit 0
          EOF
          chmod +x /tmp/bin/codesign
          export PATH="/tmp/bin:$PATH"

          # Build application archive
          xcodebuild archive -project TomoBar.xcodeproj \
                             -scheme TomoBar \
                             -configuration Release \
                             -archivePath TomoBar.xcarchive \
                             ARCHS="arm64 x86_64" \
                             ONLY_ACTIVE_ARCH=NO \
                             MARKETING_VERSION=${{github.ref_name}} \
                             CODE_SIGN_IDENTITY="-" \
                             CODE_SIGNING_REQUIRED=NO \
                             CODE_SIGNING_ALLOWED=NO

          # Export application
          xcodebuild -archivePath TomoBar.xcarchive \
                     -exportArchive \
                     -exportOptionsPlist export_options.plist \
                     -exportPath .

          # Create ZIP archive
          zip -r "TomoBar-${{env.version}}.zip" "TomoBar.app"

      - name: Create DMG
        if: github.ref_type == 'tag'
        run: |
          create-dmg \
            --volname "TomoBar" \
            --window-pos 200 120 \
            --window-size 520 300 \
            --icon-size 80 \
            --icon "TomoBar.app" 130 130 \
            --app-drop-link 380 130 \
            "TomoBar-${{env.version}}.dmg" \
            "TomoBar.app"

      - name: Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            TomoBar-${{env.version}}.zip
            TomoBar-${{env.version}}.dmg

      - name: Delete old prerelease
        if: github.ref_type == 'branch'
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          delete_release: true
          tag_name: prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Prerelease
        if: github.ref_type == 'branch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: prerelease
          prerelease: true
          files: TomoBar-${{env.version}}.zip
