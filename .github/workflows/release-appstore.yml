name: App Store Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  upload-to-testflight:
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          VERSION=$(git describe --tags --match 'v*')
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "ðŸ“¦ Building version: $VERSION"
          echo "ðŸ”– Git ref: ${{ github.ref }}"

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1'

      - name: Install certificates
        env:
          APPSTORE_CERT_BASE64: ${{ secrets.APPSTORE_CERTIFICATE_BASE64 }}
          APPSTORE_CERT_PASSWORD: ${{ secrets.APPSTORE_CERTIFICATE_PASSWORD }}
          INSTALLER_CERT_BASE64: ${{ secrets.MAC_INSTALLER_CERTIFICATE_BASE64 }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_TEMP_PASSWORD=$(uuidgen)

          security create-keychain -p "$KEYCHAIN_TEMP_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_TEMP_PASSWORD" $KEYCHAIN_PATH

          # Import Apple Distribution certificate
          APPSTORE_CERT_PATH=$RUNNER_TEMP/appstore-cert.p12
          echo "$APPSTORE_CERT_BASE64" | base64 --decode > $APPSTORE_CERT_PATH
          security import $APPSTORE_CERT_PATH -P "$APPSTORE_CERT_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          rm $APPSTORE_CERT_PATH

          # Import Mac Installer Distribution certificate
          INSTALLER_CERT_PATH=$RUNNER_TEMP/installer-cert.p12
          echo "$INSTALLER_CERT_BASE64" | base64 --decode > $INSTALLER_CERT_PATH
          security import $INSTALLER_CERT_PATH -P "" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          rm $INSTALLER_CERT_PATH

          # Set keychain as default
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_TEMP_PASSWORD" $KEYCHAIN_PATH

          echo "âœ… Certificates installed"
          security find-identity -v -p basic

      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPSTORE_PROVISIONING_PROFILE }}
        run: |
          # Install to Xcode's provisioning profiles directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.provisionprofile

          echo "Installed provisioning profile"

      - name: Build for App Store
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "::group::ðŸ”¨ Building Archive"

          xcodebuild archive \
            -project TomoBar.xcodeproj \
            -scheme TomoBar \
            -configuration Release \
            -archivePath TomoBar-AppStore.xcarchive \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty || true

          echo "::endgroup::"

          if [ -d "TomoBar-AppStore.xcarchive" ]; then
            echo "::notice::Archive created successfully"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âœ… Build Successful

          | Item | Value |
          |------|-------|
          | Version | ${{ env.version }} |
          | Configuration | Release |
          | Architectures | arm64, x86_64 |
          | Code Signing | Apple Distribution |
          | Archive | TomoBar-AppStore.xcarchive |
          EOF
          else
            echo "::error::Failed to create archive"
            cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## âŒ Build Failed

          Archive was not created. Check the build logs above for details.

          ### Common Issues
          - Code signing certificate not found
          - Build errors in source code
          - Missing dependencies
          EOF
            exit 1
          fi

      - name: Setup App Store Connect API key
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          # Validate API key secrets
          if [ -z "$API_KEY_ID" ]; then
            echo "âŒ Error: APP_STORE_CONNECT_API_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "$ISSUER_ID" ]; then
            echo "âŒ Error: APP_STORE_CONNECT_ISSUER_ID secret is not set"
            exit 1
          fi
          if [ -z "$API_KEY_CONTENT" ]; then
            echo "âŒ Error: APP_STORE_CONNECT_API_KEY secret is not set"
            exit 1
          fi

          # Create API key file in the correct location
          mkdir -p ~/private_keys
          echo "$API_KEY_CONTENT" | base64 --decode > ~/private_keys/AuthKey_${API_KEY_ID}.p8
          chmod 600 ~/private_keys/AuthKey_${API_KEY_ID}.p8

          echo "âœ… App Store Connect API key installed"
          echo "   Key ID: $API_KEY_ID"
          echo "   Issuer ID: $ISSUER_ID"
          echo "API_KEY_PATH=~/private_keys/AuthKey_${API_KEY_ID}.p8" >> $GITHUB_ENV

      - name: Export .app from archive
        run: |
          # Create export options plist
          cat > export_options.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>method</key>
          	<string>mac-application</string>
          	<key>signingCertificate</key>
          	<string>Apple Distribution</string>
          	<key>uploadBitcode</key>
          	<false/>
          	<key>uploadSymbols</key>
          	<true/>
          </dict>
          </plist>
          EOF

          echo "::group::ðŸ“¦ Exporting Application"

          xcodebuild -exportArchive \
            -archivePath TomoBar-AppStore.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist export_options.plist \
            -allowProvisioningUpdates \
            | xcpretty || true

          echo "::endgroup::"

          if [ -d "./build/TomoBar.app" ]; then
            APP_SIZE=$(du -sh ./build/TomoBar.app | awk '{print $1}')
            echo "::notice::Application exported successfully (${APP_SIZE})"
          else
            echo "::error::Failed to export application"
            exit 1
          fi

      - name: Create and sign PKG
        run: |
          echo "::group::ðŸ“¦ Creating PKG Installer"

          # Remove quarantine attributes from all files
          xattr -cr ./build/TomoBar.app

          # Create unsigned PKG
          productbuild --component ./build/TomoBar.app /Applications TomoBar-unsigned.pkg

          # Sign PKG with Mac Installer Distribution certificate
          productsign --sign "3rd Party Mac Developer Installer: Artem Yurov (2PKMU2GZD5)" \
            TomoBar-unsigned.pkg \
            TomoBar.pkg

          echo "::endgroup::"

          # Verify signature
          echo "::group::ðŸ” Verifying PKG Signature"
          pkgutil --check-signature TomoBar.pkg
          echo "::endgroup::"

          # Cleanup
          rm TomoBar-unsigned.pkg

          if [ -f "TomoBar.pkg" ]; then
            PKG_SIZE=$(du -sh TomoBar.pkg | awk '{print $1}')
            echo "::notice::PKG created and signed successfully (${PKG_SIZE})"
          else
            echo "::error::Failed to create PKG"
            exit 1
          fi

      - name: Validate PKG before upload
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          OUTPUT=$(mktemp)
          EXIT_CODE=0

          echo "::group::ðŸ” Validating PKG with Apple"

          # Run altool and capture exit code
          xcrun altool --validate-app \
            --type macos \
            --file TomoBar.pkg \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID" \
            --verbose 2>&1 | tee "$OUTPUT" || EXIT_CODE=$?

          echo "::endgroup::"

          # Check exit code first (most reliable)
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Validation failed with exit code $EXIT_CODE"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âŒ Validation Failed

          | Detail | Value |
          |--------|-------|
          | Exit Code | $EXIT_CODE |
          | File | TomoBar.pkg |
          | Status | âŒ Failed |

          ### Error Output
          \`\`\`
          $(cat "$OUTPUT")
          \`\`\`

          ### Troubleshooting
          - Check bundle identifier matches provisioning profile
          - Verify all entitlements are valid
          - Ensure PKG is properly signed
          - Check App Store Connect for bundle ID configuration

          [App Store Connect](https://appstoreconnect.apple.com/)
          EOF
            rm "$OUTPUT"
            exit $EXIT_CODE
          fi

          # Check for failure patterns
          if grep -q "VERIFY FAILED\|VALIDATION FAILED\|Failed to validate" "$OUTPUT"; then
            echo "::error::Validation failed"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âŒ Validation Failed

          ### Error Details
          \`\`\`
          $(grep -A 5 "FAILED\|Failed" "$OUTPUT" || cat "$OUTPUT")
          \`\`\`

          ### Common Issues
          1. **Invalid entitlements** - Check TomoBar.entitlements
          2. **Code signing mismatch** - Verify certificate and provisioning profile
          3. **Missing capabilities** - Enable required capabilities in App Store Connect

          [Troubleshooting Guide](https://developer.apple.com/documentation/xcode/distributing-your-app-to-registered-devices)
          EOF
            rm "$OUTPUT"
            exit 1
          fi

          # Check for warnings and fail
          if grep -q "WARNING\|WARN:" "$OUTPUT"; then
            echo "::warning::Validation completed with warnings - failing as configured"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âš ï¸ Validation Warnings

          Warnings detected in validation output. Build configured to fail on warnings.

          ### Warning Details
          \`\`\`
          $(grep -i "warning\|warn" "$OUTPUT")
          \`\`\`
          EOF
            rm "$OUTPUT"
            exit 1
          fi

          # Verify success
          if grep -q "No errors" "$OUTPUT"; then
            echo "::notice::Validation passed successfully"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âœ… Validation Successful

          PKG validated successfully by Apple. Ready for upload.

          | Detail | Value |
          |--------|-------|
          | File | TomoBar.pkg |
          | Version | ${{ env.version }} |
          | Status | âœ… Validated |
          EOF
            rm "$OUTPUT"
          else
            echo "::error::Unexpected validation output"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âš ï¸ Validation Status Unknown

          Validation completed but result is unclear.

          ### Output
          \`\`\`
          $(cat "$OUTPUT")
          \`\`\`
          EOF
            rm "$OUTPUT"
            exit 1
          fi

      - name: Upload PKG to App Store Connect
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          OUTPUT=$(mktemp)
          EXIT_CODE=0
          START_TIME=$(date +%s)

          echo "::group::ðŸ“¤ Uploading to App Store Connect"

          # Run altool and capture exit code
          xcrun altool --upload-app \
            --type macos \
            --file TomoBar.pkg \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID" \
            --verbose 2>&1 | tee "$OUTPUT" || EXIT_CODE=$?

          echo "::endgroup::"

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Check exit code first (most reliable)
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Upload failed with exit code $EXIT_CODE"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âŒ Upload Failed

          | Detail | Value |
          |--------|-------|
          | Exit Code | $EXIT_CODE |
          | Duration | ${DURATION}s |
          | Status | âŒ Failed |

          ### Error Output
          \`\`\`
          $(cat "$OUTPUT")
          \`\`\`
          EOF
            rm "$OUTPUT"
            exit $EXIT_CODE
          fi

          # Check for DUPLICATE version error specifically
          if grep -q "ENTITY_ERROR.ATTRIBUTE.INVALID.DUPLICATE" "$OUTPUT"; then
            echo "::error::Duplicate version detected"

            # Try to extract current version info
            CURRENT_VERSION=$(grep -o "CFBundleShortVersionString.*" "$OUTPUT" | head -1 || echo "Unknown")
            CURRENT_BUILD=$(grep -o "CFBundleVersion.*" "$OUTPUT" | head -1 || echo "Unknown")

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âŒ Upload Failed: Duplicate Version

          ### Problem
          This version was already uploaded to App Store Connect.

          | Setting | Current Value |
          |---------|---------------|
          | Version (MARKETING_VERSION) | ${{ env.version }} |
          | Build (CURRENT_PROJECT_VERSION) | See project.pbxproj |

          ### Solution
          Increment the build number in **project.pbxproj**:

          \`\`\`bash
          # Edit these lines (appears twice in file):
          # TomoBar.xcodeproj/project.pbxproj:506
          # TomoBar.xcodeproj/project.pbxproj:556

          CURRENT_PROJECT_VERSION = X;  # Increment X to next number
          \`\`\`

          Or increment MARKETING_VERSION:
          \`\`\`bash
          # TomoBar.xcodeproj/project.pbxproj
          MARKETING_VERSION = X.Y.Z;  # Bump version
          \`\`\`

          ### Error Details
          \`\`\`
          $(grep -A 10 "ENTITY_ERROR" "$OUTPUT" || cat "$OUTPUT")
          \`\`\`

          [App Store Connect Builds](https://appstoreconnect.apple.com/apps)
          EOF
            rm "$OUTPUT"
            exit 1
          fi

          # Check for other failure patterns
          if grep -q "UPLOAD FAILED\|Failed to upload\|ENTITY_ERROR" "$OUTPUT"; then
            echo "::error::Upload failed"

            # Try to extract specific error
            ERROR_MSG=$(grep -o "ENTITY_ERROR[^\"]*" "$OUTPUT" | head -1 || echo "Unknown error")

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âŒ Upload Failed

          ### Error Type
          \`$ERROR_MSG\`

          ### Full Error Output
          \`\`\`
          $(cat "$OUTPUT")
          \`\`\`

          ### Common Issues
          1. **Bundle ID mismatch** - Verify bundle identifier in Xcode matches App Store Connect
          2. **Invalid version** - Ensure version follows semantic versioning (X.Y.Z)
          3. **Expired certificate** - Check certificate is valid and not expired
          4. **Missing entitlements** - Verify all required entitlements are present

          ### Documentation
          - [App Distribution Guide](https://developer.apple.com/documentation/xcode/distributing-your-app-for-beta-testing-and-releases)
          - [App Store Connect API](https://developer.apple.com/documentation/appstoreconnectapi)

          [App Store Connect](https://appstoreconnect.apple.com/)
          EOF
            rm "$OUTPUT"
            exit 1
          fi

          # Check for warnings and fail
          if grep -q "WARNING\|WARN:" "$OUTPUT"; then
            echo "::warning::Upload completed with warnings - failing as configured"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âš ï¸ Upload Warnings

          Upload completed but warnings were detected. Build configured to fail on warnings.

          ### Warning Details
          \`\`\`
          $(grep -i "warning\|warn" "$OUTPUT")
          \`\`\`
          EOF
            rm "$OUTPUT"
            exit 1
          fi

          # Verify success
          if grep -q "No errors uploading" "$OUTPUT"; then
            echo "::notice::Upload completed successfully in ${DURATION}s"

            # Try to extract request ID if present
            REQUEST_ID=$(grep -o "RequestUUID = [^;]*" "$OUTPUT" | cut -d= -f2 | tr -d ' ' || echo "N/A")

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âœ… Upload Successful

          | Detail | Value |
          |--------|-------|
          | Version | ${{ env.version }} |
          | Duration | ${DURATION}s |
          | Request ID | \`${REQUEST_ID}\` |
          | Status | âœ… Uploaded |

          ### Next Steps
          1. Go to [App Store Connect](https://appstoreconnect.apple.com/)
          2. Navigate to **TestFlight â†’ macOS**
          3. Wait for processing to complete (usually 5-15 minutes)
          4. Once processed, distribute to testers or submit for review

          ### Processing Status
          The build will appear in App Store Connect once Apple finishes processing it.
          You'll receive an email when processing is complete.

          [View Builds in App Store Connect](https://appstoreconnect.apple.com/apps)
          EOF
            rm "$OUTPUT"
          else
            echo "::error::Unexpected upload output"

            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âš ï¸ Upload Status Unknown

          Upload completed but result is unclear. Check App Store Connect manually.

          ### Output
          \`\`\`
          $(cat "$OUTPUT")
          \`\`\`

          [App Store Connect](https://appstoreconnect.apple.com/)
          EOF
            rm "$OUTPUT"
            exit 1
          fi
