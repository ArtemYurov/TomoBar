name: App Store Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  upload-to-testflight:
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          VERSION=$(git describe --tags --match 'v*')
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "üì¶ Building version: $VERSION"
          echo "üîñ Git ref: ${{ github.ref }}"

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1'

      - name: Install certificates
        env:
          APPSTORE_CERT_BASE64: ${{ secrets.APPSTORE_CERTIFICATE_BASE64 }}
          APPSTORE_CERT_PASSWORD: ${{ secrets.APPSTORE_CERTIFICATE_PASSWORD }}
          INSTALLER_CERT_BASE64: ${{ secrets.MAC_INSTALLER_CERTIFICATE_BASE64 }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_TEMP_PASSWORD=$(uuidgen)

          security create-keychain -p "$KEYCHAIN_TEMP_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_TEMP_PASSWORD" $KEYCHAIN_PATH

          # Import Apple Distribution certificate
          APPSTORE_CERT_PATH=$RUNNER_TEMP/appstore-cert.p12
          echo "$APPSTORE_CERT_BASE64" | base64 --decode > $APPSTORE_CERT_PATH
          security import $APPSTORE_CERT_PATH -P "$APPSTORE_CERT_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          rm $APPSTORE_CERT_PATH

          # Import Mac Installer Distribution certificate
          INSTALLER_CERT_PATH=$RUNNER_TEMP/installer-cert.p12
          echo "$INSTALLER_CERT_BASE64" | base64 --decode > $INSTALLER_CERT_PATH
          security import $INSTALLER_CERT_PATH -P "" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          rm $INSTALLER_CERT_PATH

          # Set keychain as default
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_TEMP_PASSWORD" $KEYCHAIN_PATH

          echo "‚úÖ Certificates installed"
          security find-identity -v -p basic

      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPSTORE_PROVISIONING_PROFILE }}
        run: |
          # Install to Xcode's provisioning profiles directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.provisionprofile

          echo "Installed provisioning profile"

      - name: Build for App Store
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "Building for App Store (without Sparkle)..."

          xcodebuild archive \
            -project TomoBar.xcodeproj \
            -scheme TomoBar \
            -configuration Release \
            -archivePath TomoBar-AppStore.xcarchive \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty || true

          echo "Archive created successfully"
          ls -la TomoBar-AppStore.xcarchive/

      - name: Setup App Store Connect API key
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          # Validate API key secrets
          if [ -z "$API_KEY_ID" ]; then
            echo "‚ùå Error: APP_STORE_CONNECT_API_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "$ISSUER_ID" ]; then
            echo "‚ùå Error: APP_STORE_CONNECT_ISSUER_ID secret is not set"
            exit 1
          fi
          if [ -z "$API_KEY_CONTENT" ]; then
            echo "‚ùå Error: APP_STORE_CONNECT_API_KEY secret is not set"
            exit 1
          fi

          # Create API key file in the correct location
          mkdir -p ~/private_keys
          echo "$API_KEY_CONTENT" | base64 --decode > ~/private_keys/AuthKey_${API_KEY_ID}.p8
          chmod 600 ~/private_keys/AuthKey_${API_KEY_ID}.p8

          echo "‚úÖ App Store Connect API key installed"
          echo "   Key ID: $API_KEY_ID"
          echo "   Issuer ID: $ISSUER_ID"
          echo "API_KEY_PATH=~/private_keys/AuthKey_${API_KEY_ID}.p8" >> $GITHUB_ENV

      - name: Export .app from archive
        run: |
          echo "Exporting .app from archive..."

          # Create export options plist
          cat > export_options.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>method</key>
          	<string>mac-application</string>
          	<key>signingCertificate</key>
          	<string>Apple Distribution</string>
          	<key>uploadBitcode</key>
          	<false/>
          	<key>uploadSymbols</key>
          	<true/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath TomoBar-AppStore.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist export_options.plist \
            -allowProvisioningUpdates \
            | xcpretty || true

          echo "‚úÖ .app exported"
          ls -la ./build/

      - name: Create and sign PKG
        run: |
          echo "Creating PKG installer..."

          # Remove quarantine attributes from all files
          echo "Removing quarantine attributes..."
          xattr -cr ./build/TomoBar.app

          # Create unsigned PKG
          productbuild --component ./build/TomoBar.app /Applications TomoBar-unsigned.pkg

          # Sign PKG with Mac Installer Distribution certificate
          productsign --sign "3rd Party Mac Developer Installer: Artem Yurov (2PKMU2GZD5)" \
            TomoBar-unsigned.pkg \
            TomoBar.pkg

          # Verify signature
          pkgutil --check-signature TomoBar.pkg

          # Cleanup
          rm TomoBar-unsigned.pkg

          echo "‚úÖ PKG created and signed"
          ls -lh TomoBar.pkg

      - name: Validate PKG before upload
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          echo "Validating PKG with Apple..."

          # Capture output to check for failures
          OUTPUT=$(mktemp)

          xcrun altool --validate-app \
            --type macos \
            --file TomoBar.pkg \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID" \
            --verbose 2>&1 | tee "$OUTPUT"

          # Check if validation failed
          if grep -q "VERIFY FAILED\|VALIDATION FAILED" "$OUTPUT"; then
            echo ""
            echo "‚ùå Validation failed!"
            echo "Check the logs above for validation errors"
            rm "$OUTPUT"
            exit 1
          fi

          rm "$OUTPUT"
          echo ""
          echo "‚úÖ Validation passed! Proceeding to upload..."

      - name: Upload PKG to App Store Connect
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          echo "Uploading PKG to App Store Connect..."

          # Capture output to check for failures
          OUTPUT=$(mktemp)

          xcrun altool --upload-app \
            --type macos \
            --file TomoBar.pkg \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID" \
            --verbose 2>&1 | tee "$OUTPUT"

          # Check if upload failed
          if grep -q "UPLOAD FAILED" "$OUTPUT"; then
            echo ""
            echo "‚ùå Upload failed with validation errors!"
            echo "Check the logs above for details"
            rm "$OUTPUT"
            exit 1
          fi

          rm "$OUTPUT"
          echo ""
          echo "‚úÖ Upload completed successfully!"
          echo "Check App Store Connect ‚Üí TestFlight ‚Üí macOS for processing status"
